---
description: Parse source code dependencies using tree-sitter. Confirms linkages and validates code map accuracy. Persists to docs/DEPS_MAP.md with git-based incremental updates.
---

# Deps Command

This command uses the **tree-sitter MCP server** to parse and analyze code dependencies, with **persistent storage** and **git-based incremental updates**.

## What This Command Does

1. **Check for Existing Map** - Look for `docs/DEPS_MAP.md`
2. **Detect Changes** - Use git diff since last analysis
3. **Analyze Dependencies** - Parse only changed files (or all on first run)
4. **Merge Updates** - Incrementally update the dependency map
5. **Validate Code Map** - Compare against CODEBASE_MAP.md
6. **Persist Results** - Save to `docs/DEPS_MAP.md` with timestamp

## Persistent Dependency Map

The command saves analysis to `docs/DEPS_MAP.md` with this structure:

```markdown
---
last_analyzed: 2026-02-04T18:37:55Z
git_commit: ee4b85a6073efd5711777a4bea3968333d48a15f
total_files: 51
languages:
  - go
  - typescript
---

# Dependency Map

> Auto-generated by /deps. Last analyzed: 2026-02-04T18:37:55Z

## Backend (Go)
[file dependencies...]

## Frontend (TypeScript)
[file dependencies...]
```

## Workflow

### Step 1: Check for Existing Map

First, check if `docs/DEPS_MAP.md` exists:

```bash
# Check if map exists
ls docs/DEPS_MAP.md
```

**If map exists:**
1. Read the `git_commit` from frontmatter
2. Run `git diff <last_commit>..HEAD --name-only` to find changed files
3. If no changes, report "Dependency map is current"
4. If changes, proceed to incremental update

**If map does not exist:** Proceed to full analysis.

### Step 2: Get Git Context

```bash
# Get current commit hash
git rev-parse HEAD

# Get timestamp
date -u +"%Y-%m-%dT%H:%M:%SZ"

# If updating, get changed files since last analysis
git diff <last_commit>..HEAD --name-only --diff-filter=ACMR
```

### Step 3: Detect Languages

Scan the codebase for source files:

```bash
# Find all source files by extension
find . -name "*.go" -o -name "*.ts" -o -name "*.tsx" -o -name "*.py" -o -name "*.java" | head -100
```

Map extensions to languages:
- `.go` → Go
- `.ts`, `.tsx` → TypeScript
- `.py` → Python
- `.java` → Java
- `.js`, `.jsx` → JavaScript

### Step 4: Analyze Dependencies

Call the tree-sitter MCP server for each language detected:

```json
{
  "path": "/absolute/path/to/source",
  "language": "go",
  "depth": "full"
}
```

**IMPORTANT:** Use absolute paths for the tree-sitter MCP tool.

### Step 5: Build Dependency Map

Structure the analysis into:

1. **File Dependencies** - What each file imports/exports
2. **Dependency Graph** - File-level and function-level graphs
3. **External Dependencies** - Third-party packages used
4. **Validation Results** - Comparison with CODEBASE_MAP.md

### Step 6: Write DEPS_MAP.md

Create or update `docs/DEPS_MAP.md`:

```markdown
---
last_analyzed: {timestamp}
git_commit: {commit_hash}
total_files: {count}
languages:
  - {lang1}
  - {lang2}
---

# Dependency Map

> Auto-generated by /deps. Last analyzed: {timestamp}

## Summary

| Language | Files | Modules |
|----------|-------|---------|
| Go | 27 | 8 |
| TypeScript | 24 | 5 |

## Backend (Go)

### File Dependencies

| File | Internal Imports | External Imports |
|------|------------------|------------------|
| cmd/api/main.go | handlers, services, middleware | chi, pgxpool |
| internal/handlers/trail.go | response, services | chi, uuid |

### Dependency Graph

```
cmd/api/main.go
├── internal/handlers/
│   └── internal/services/
│       └── internal/repository/
├── internal/middleware/
└── internal/config/
```

### External Dependencies

| Package | Version | Used By |
|---------|---------|---------|
| github.com/go-chi/chi/v5 | v5.x | main.go, handlers |
| github.com/jackc/pgx/v5 | v5.x | repository |

## Frontend (TypeScript)

### File Dependencies

| File | Internal Imports | External Imports |
|------|------------------|------------------|
| App.tsx | stores, pages, components | react-router-dom, react-query |
| pages/HomePage.tsx | stores, hooks, components | react-query, react |

### Dependency Graph

```
main.tsx
└── App.tsx
    ├── store/authStore.ts
    ├── store/themeStore.ts
    └── pages/HomePage.tsx
        ├── components/TrailMap.tsx
        └── components/TrailList.tsx
```

### External Dependencies

| Package | Used By |
|---------|---------|
| react | All components |
| zustand | stores |
| recharts | ElevationProfile |

## Validation

Comparing against CODEBASE_MAP.md...

| Check | Status |
|-------|--------|
| Backend layers | ✅ Confirmed |
| Frontend stores | ✅ Confirmed |
| Missing dependencies | ⚠️ 2 undocumented |

### Undocumented Dependencies

- `processor.py → subprocess` (external)
- `utils.ts → lodash` (external)

---

*Generated by /deps command*
```

## Incremental Update Mode

When updating an existing map:

1. **Read existing DEPS_MAP.md**
2. **Get changed files from git**
   ```bash
   git diff {last_commit}..HEAD --name-only --diff-filter=ACMR | grep -E '\.(go|ts|tsx|py|java)$'
   ```
3. **Analyze only changed files**
4. **Merge new analysis with existing map**
   - Update entries for changed files
   - Remove entries for deleted files
   - Keep unchanged entries as-is
5. **Update frontmatter** (timestamp, commit hash)
6. **Write updated DEPS_MAP.md**

## Example Usage

### First Run (Full Analysis)

```
User: /deps

Agent:
# Dependency Analysis

No existing DEPS_MAP.md found. Running full analysis...

## Languages Detected
- Go (27 files in backend/)
- TypeScript (24 files in frontend/src/)

## Analyzing...

[Calls tree-sitter MCP for Go]
[Calls tree-sitter MCP for TypeScript]

## Results

Created docs/DEPS_MAP.md with:
- 51 files analyzed
- 2 languages
- Commit: ee4b85a

### Backend Dependency Graph
[shows graph]

### Frontend Dependency Graph
[shows graph]

### Validation
✅ All dependencies match CODEBASE_MAP.md
```

### Incremental Update

```
User: /deps

Agent:
# Dependency Analysis

Found existing DEPS_MAP.md (last analyzed: 2026-02-04T18:37:55Z)

## Checking for changes...

Files changed since ee4b85a:
- frontend/src/components/NewFeature.tsx (added)
- frontend/src/lib/api.ts (modified)
- backend/internal/handlers/trail.go (modified)

## Analyzing 3 changed files...

[Calls tree-sitter MCP for changed files only]

## Results

Updated docs/DEPS_MAP.md:
- 3 files re-analyzed
- New commit: abc1234
- New dependencies found: 2

### Changes
- NewFeature.tsx imports: react, ../store/trailStore
- api.ts: No changes to dependencies
- trail.go: Added import for "encoding/json"
```

## Output Format

The tree-sitter-deps tool returns structured JSON:

```json
{
  "analysis": {
    "path": "/path/to/src",
    "language": "python",
    "files_analyzed": 6
  },
  "files": {
    "processor.py": {
      "imports": {
        "external": ["fitz", "subprocess"],
        "internal": ["llm_client", "utils"]
      },
      "exports": {
        "functions": ["process_document", "detect_type"],
        "classes": ["DocumentProcessor"],
        "constants": []
      },
      "functions": {
        "process_document": {
          "calls": [
            {"target": "detect_type", "line": 45},
            {"target": "llm_client.analyze", "line": 78}
          ],
          "params": ["file_path", "config"],
          "returns": "dict"
        }
      }
    }
  },
  "dependency_graph": {
    "file_level": {
      "coordinator.py": ["processor.py", "exporter.py"]
    },
    "function_level": {
      "coordinator.run_pipeline": [
        "processor.process_document",
        "exporter.export_to_excel"
      ]
    }
  }
}
```

## Supported Languages

| Language | Extensions | Grammar |
|----------|-----------|---------|
| Python | `.py` | tree-sitter-python |
| TypeScript | `.ts`, `.tsx` | tree-sitter-typescript |
| JavaScript | `.js`, `.jsx` | tree-sitter-javascript |
| Go | `.go` | tree-sitter-go |
| Java | `.java` | tree-sitter-java |

For unsupported languages, use `/grammar` to generate a custom grammar.

## Analysis Depth Options

- **file** - Imports and exports only
- **function** - Add function-level call graph
- **full** - Complete analysis with all details

## Integration with Other Commands

- Use `/deps` before `/trophy` to understand code structure
- Use `/deps` to validate CODEBASE_MAP.md accuracy
- Use `/deps` during `/orchestrate` workflows
- Use `/grammar` if language grammar is missing
- Use `/cartographer` to generate CODEBASE_MAP.md first

## Prerequisites

Requires the tree-sitter MCP server to be configured:

```json
// .claude/settings.json or ~/.claude/settings.json
{
  "mcpServers": {
    "tree-sitter": {
      "command": "uvx",
      "args": ["mcp-tree-sitter"]
    }
  }
}
```

## Custom Grammars

For languages not supported out-of-the-box (AS/400 RPG, COBOL, etc.), first generate a grammar:

```
/grammar rpgle src/as400/
```

Then `/deps` will work with the custom grammar.

## Troubleshooting

| Issue | Solution |
|-------|----------|
| "path does not exist" | Use absolute paths for tree-sitter MCP |
| Large output truncated | Output saved to temp file, read in chunks |
| No git history | Full analysis runs, no incremental updates |
| Language not detected | Specify language explicitly or use /grammar |
